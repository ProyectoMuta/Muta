<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MUTA · Ventas</title>
  <link rel="stylesheet" href="css/admin_base.css" />
  <link rel="stylesheet" href="css/gestion_producto_mantenimiento.css" />
    <link rel="stylesheet" href="css/navbar.css">
  <link rel="stylesheet" href="css/acceso-usuario.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"/>

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="img/favicon.jpeg">

  <style>
    .dropdown-menu {
      min-width: 150px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      margin-top: 4px;
      /* Posicionamiento absoluto para el menú */
      position: absolute;
      background: white;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      z-index: 1000; /* Alto z-index para el menú en sí */
      display: none;
      right: 0; /* Alineado a la derecha por defecto */
    }

    .dropdown-item {
      display: block;
      padding: 10px 16px;
      color: #333;
      text-decoration: none;
      transition: background-color 0.2s;
      border-bottom: 1px solid #f0f0f0;
    }

    .dropdown-item:last-child {
      border-bottom: none;
    }

    .dropdown-item:hover {
      background-color: #f5f5f5;
      color: #4B6BFE;
    }
    
    /* Contenedor del dropdown */
    .dropdown {
        display: inline-block;
        position: relative; /* Clave para el z-index */
        z-index: 1; /* z-index base */
    }

    .detalle-row {
      transition: all 0.3s ease;
    }

    .detalle-content {
      animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .detail-group {
      margin-bottom: 12px;
    }

    .detail-label {
      font-size: 12px;
      color: #666;
      text-transform: uppercase;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .detail-value {
      font-size: 14px;
      color: #333;
      line-height: 1.6;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <aside class="side">
      <div class="brand">MUTA</div>
      <nav class="side-nav">
        <a href="home_mantenimiento.html" class="item"><i class="bi bi-speedometer2"></i> Dashboard</a>
        <a href="venta_mantenimiento.html" class="item active"><i class="bi bi-cash-coin"></i> Ventas</a>
        <a href="gestion_producto_mantenimiento.html" class="item"><i class="bi bi-bag"></i> Productos</a>
        <a href="analisis_mantenimiento.html" class="item"><i class="bi bi-graph-up"></i> Análisis</a>
        <a href="envios_mantenimiento.html" class="item"><i class="bi bi-truck"></i> Envíos</a>
        <a href="soporte_mantenimiento.html" class="item"><i class="bi bi-life-preserver"></i> Soporte</a>
      </nav>
    </aside>

    <main class="main">
      <header class="topbar">
        <h1>Gestión de Ventas</h1>
        <div class="search">
          <i class="bi bi-search"></i>
          <input id="q" type="search" placeholder="Buscar por venta o cliente…">
        </div>
           <div class="icons">
         <button id="open-auth" class="icono_usuario" title="Mi cuenta" type="button">
        <i class="bi bi-person"></i>
      </button></div>
      </header>
<div class="stats-row">
    <div class="stat-card">
        <div class="stat-label">TOTAL VENTAS</div>
        <div class="stat-value" id="totalVentas">$0</div> 
    </div>
    <div class="stat-card">
        <div class="stat-label">PEDIDOS</div>
        <div class="stat-value" id="totalPedidos">0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">PENDIENTES</div>
        <div class="stat-value" id="pedidosPendientes">0</div>
    </div>
</div>


      <div class="filters">
          <button class="chip active" data-f="todos">Todos</button>
        <button class="chip" data-f="en_espera">En Espera</button>
        <button class="chip" data-f="pagado">Pagado</button>
        <button class="chip" data-f="enviado">Enviado</button>
        <button class="chip" data-f="recibido">Recibido</button>
        <button class="chip" data-f="cancelado">Cancelado</button>
      </div>

      <section class="card">
        <div class="table-wrap">
          <table class="table" id="tbl">
            <thead>
              <tr>
                <th>N° Pedido</th>
                <th>Fecha</th>
                <th>Usuario ID</th>
                <th>Total</th>
                <th>Productos</th>
                <th>Estado de pago</th>
                <th>Modo de pago</th>
                <th>Estado de envío</th>
              </tr>
            </thead>
            <tbody   id="tbody">
               
            </tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

  <!-- Modal de detalles -->
  <div class="modal-overlay" id="modalDetalles">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Detalles del Pedido</h3>
        <button class="modal-close" onclick="cerrarModal()">&times;</button>
      </div>
      <div id="modalBody"></div>
    </div>
  </div>

 <div id="acceso-usuario"></div>
  <script>
  let pedidosData = [];
    let filtroActual = 'todos';
    let busqueda = '';

    // Mapeo de ESTADO GENERAL (envío)
    const ESTADO_BADGES = {
      'en_espera': '<span class="badge pay-pend">En Espera</span>',
      'pagado': '<span class="badge pay-ok">Pagado</span>',
      'enviado': '<span class="badge ship-ok">Enviado</span>',
      'recibido': '<span class="badge ship-ok">Recibido</span>',
      'cancelado': '<span class="badge danger">Cancelado</span>'
    };
    
    // --- NUEVO ---
    // Mapeo de ESTADO PAGO
    const ESTADO_PAGO_BADGES = {
      'pendiente': '<span class="badge pay-pend">Pendiente</span>',
      'aprobado': '<span class="badge pay-ok">Aprobado</span>',
      'rechazado': '<span class="badge danger">Rechazado</span>',
      'reembolsado': '<span class="badge warn">Reembolsado</span>'
    };

    const METODO_PAGO = {
      'tarjeta': 'Tarjeta',
      'mercadopago': 'Mercado Pago',
      'transferencia': 'Transferencia',
      'efectivo': 'Efectivo'
    };

    // Formatear moneda
    function fmt(num) {
      return '$' + Number(num || 0).toLocaleString('es-AR');
    }

    // Formatear fecha
    function formatearFecha(fecha) {
      const d = new Date(fecha);
      return d.toLocaleDateString('es-AR') + ' ' + d.toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit' });
    }

    // Cargar pedidos desde MongoDB
    async function cargarPedidos() {
      try {
        let url = 'backend/pedidosController.php?action=listar';
        
        if (filtroActual !== 'todos') {
          url += `&estado=${filtroActual}`;
        }
        
        if (busqueda) {
          url += `&buscar=${encodeURIComponent(busqueda)}`;
        }

        const response = await fetch(url);
        const data = await response.json();

        if (data.success) {
          pedidosData = data.pedidos;
          renderizarTabla(data.pedidos);
          actualizarEstadisticas(data.pedidos);
        } else {
          mostrarError('Error al cargar pedidos');
        }
      } catch (error) {
        console.error('Error:', error);
        mostrarError('Error de conexión');
      }
    }

    // Renderizar tabla
    function renderizarTabla(pedidos) {
      const tbody = document.getElementById('tbody');

      if (pedidos.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:40px; color:#999;">No hay pedidos para mostrar</td></tr>';
        return;
      }

      tbody.innerHTML = pedidos.map(pedido => `
        <tr data-pedido-id="${pedido.id}">
          <td><strong>${pedido.numero_pedido}</strong></td>
          <td>${formatearFecha(pedido.fecha_compra)}</td>
          <td>${pedido.usuario_id}</td>
          <td><strong>${fmt(pedido.total)}</strong></td>
          <td>${pedido.productos.length} producto(s)</td>
          
          <td>
            ${ESTADO_PAGO_BADGES[pedido.estado_pago] || pedido.estado_pago}
            <div class="dropdown">
              <button class="btn-action dropdown-toggle" onclick="toggleDropdown(event, 'dropdown-pago-${pedido.id}')">
                <i class="bi bi-pencil-square"></i>
              </button>
              <div class="dropdown-menu" id="dropdown-pago-${pedido.id}">
                <a class="dropdown-item" href="#" onclick="cambiarEstadoPago('${pedido.id}', 'pendiente'); return false;">Pendiente</a>
                <a class="dropdown-item" href="#" onclick="cambiarEstadoPago('${pedido.id}', 'aprobado'); return false;">Aprobado</a>
                <a class="dropdown-item" href="#" onclick="cambiarEstadoPago('${pedido.id}', 'rechazado'); return false;">Rechazado</a>
                <a class="dropdown-item" href="#" onclick="cambiarEstadoPago('${pedido.id}', 'reembolsado'); return false;">Reembolsado</a>
              </div>
            </div>
          </td>
          <td>${METODO_PAGO[pedido.metodo_pago] || pedido.metodo_pago}</td>
          
          <td>
            ${ESTADO_BADGES[pedido.estado] || pedido.estado}
            
            <button class="btn-action" onclick="toggleDetalles('${pedido.id}')">
              <i class="bi bi-eye"></i> <span class="toggle-text">Ver</span>
            </button>
            
            <div class="dropdown" style="z-index: 1;">
              <button class="btn-action dropdown-toggle" onclick="toggleDropdown(event, 'dropdown-envio-${pedido.id}')">
                <i class="bi bi-arrow-repeat"></i> Estado
              </button>
              <div class="dropdown-menu" id="dropdown-envio-${pedido.id}">
                <a class="dropdown-item" href="#" onclick="cambiarEstadoEnvio('${pedido.id}', 'en_espera'); return false;">En Espera</a>
                <a class="dropdown-item" href="#" onclick="cambiarEstadoEnvio('${pedido.id}', 'pagado'); return false;">Pagado</a>
                <a class="dropdown-item" href="#" onclick="cambiarEstadoEnvio('${pedido.id}', 'enviado'); return false;">Enviado</a>
                <a class="dropdown-item" href="#" onclick="cambiarEstadoEnvio('${pedido.id}', 'recibido'); return false;">Recibido</a>
                <a class="dropdown-item" href="#" onclick="cambiarEstadoEnvio('${pedido.id}', 'cancelado'); return false;">Cancelado</a>
              </div>
            </div>
          </td>
          </tr>
        <tr class="detalle-row" id="detalle-${pedido.id}" style="display: none;">
          <td colspan="8" style="padding: 0;">
            <div class="detalle-content" style="padding: 20px; background: #f9f9f9; border-top: 1px solid #eee;">
              <div class="loading-detalle">Cargando detalles...</div>
            </div>
          </td>
        </tr>
      `).join('');
    }

    // Actualizar estadísticas
    function actualizarEstadisticas(pedidos) {
      const totalVentas = pedidos.reduce((sum, p) => sum + Number(p.total), 0);
      const pendientes = pedidos.filter(p => p.estado === 'en_espera').length;

      document.getElementById('totalVentas').textContent = fmt(totalVentas);
      document.getElementById('totalPedidos').textContent = pedidos.length;
      document.getElementById('pedidosPendientes').textContent = pendientes;
    }

    // Toggle detalles desplegables en la tabla
    async function toggleDetalles(id) {
      const detalleRow = document.getElementById(`detalle-${id}`);
      const btn = event.target.closest('button');
      const toggleText = btn.querySelector('.toggle-text');

      if (detalleRow.style.display === 'none') {
        // Cerrar todos los demás detalles abiertos
        document.querySelectorAll('.detalle-row').forEach(row => {
          row.style.display = 'none';
        });
        document.querySelectorAll('.toggle-text').forEach(text => {
          text.textContent = 'Ver';
        });

        // Abrir este detalle
        detalleRow.style.display = 'table-row';
        toggleText.textContent = 'Ocultar';

        // Cargar detalles si no están cargados
        if (detalleRow.dataset.loaded !== 'true') {
          await cargarDetallesPedido(id);
        }
      } else {
        // Cerrar este detalle
        detalleRow.style.display = 'none';
        toggleText.textContent = 'Ver';
      }
    }

    // Cargar detalles del pedido
    async function cargarDetallesPedido(id) {
      try {
        const response = await fetch(`backend/pedidosController.php?action=obtener&id=${id}`);
        const data = await response.json();

        if (data.success) {
          const pedido = data.pedido;
          const detalleRow = document.getElementById(`detalle-${id}`);
          const detalleContent = detalleRow.querySelector('.detalle-content');

          detalleContent.innerHTML = `
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
              <div class="detail-group">
                <div class="detail-label">Número de Pedido</div>
                <div class="detail-value"><strong>${pedido.numero_pedido}</strong></div>
              </div>

              <div class="detail-group">
                <div class="detail-label">Usuario ID</div>
                <div class="detail-value">${pedido.usuario_id}</div>
              </div>

              <div class="detail-group">
                <div class="detail-label">Fecha de Compra</div>
                <div class="detail-value">${formatearFecha(pedido.fecha_compra)}</div>
              </div>

              <div class="detail-group">
                <div class="detail-label">Estado (Envío)</div>
                <div class="detail-value">${ESTADO_BADGES[pedido.estado]}</div>
              </div>
              
              <div class="detail-group">
                <div class="detail-label">Estado de Pago</div>
                <div class="detail-value">${ESTADO_PAGO_BADGES[pedido.estado_pago]}</div>
              </div>
              
            </div>

            <div class="detail-group" style="margin-top: 20px;">
              <div class="detail-label">Productos</div>
              <div class="productos-list" style="display: grid; gap: 10px; margin-top: 10px;">
                ${pedido.productos.map(prod => `
                  <div class="producto-item" style="display: flex; justify-content: space-between; padding: 12px; background: white; border-radius: 4px; border: 1px solid #e0e0e0;">
                    <div>
                      <strong>${prod.nombre}</strong><br>
                      <small style="color: #666;">Talle: ${prod.talle} | Color: ${prod.color} | Cant: ${prod.cantidad}</small>
                    </div>
                    <div><strong>${fmt(prod.subtotal)}</strong></div>
                  </div>
                `).join('')}
              </div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;">
              <div class="detail-group">
                <div class="detail-label">Dirección de Envío</div>
                <div class="detail-value">
                  ${pedido.direccion_envio.calle}<br>
                  ${pedido.direccion_envio.ciudad}, ${pedido.direccion_envio.provincia}<br>
                  CP: ${pedido.direccion_envio.codigo_postal}<br>
                  Tel: ${pedido.direccion_envio.telefono}
                  ${pedido.direccion_envio.referencia ? `<br>Ref: ${pedido.direccion_envio.referencia}` : ''}
                </div>
              </div>

              <div class="detail-group">
                <div class="detail-label">Totales</div>
                <div class="detail-value">
                  Subtotal: ${fmt(pedido.subtotal)}<br>
                  Envío: ${fmt(pedido.costo_envio)}<br>
                  ${pedido.descuento > 0 ? `Descuento: ${fmt(pedido.descuento)}<br>` : ''}
                  <strong>Total: ${fmt(pedido.total)}</strong>
                </div>
              </div>

              ${pedido.numero_tracking ? `
                <div class="detail-group">
                  <div class="detail-label">Número de Tracking</div>
                  <div class="detail-value">${pedido.numero_tracking}</div>
                </div>
              ` : ''}

              ${pedido.notas_cliente ? `
                <div class="detail-group">
                  <div class="detail-label">Notas del Cliente</div>
                  <div class="detail-value">${pedido.notas_cliente}</div>
                </div>
              ` : ''}
            </div>
          `;

          detalleRow.dataset.loaded = 'true';
        }
      } catch (error) {
        console.error('Error:', error);
        const detalleRow = document.getElementById(`detalle-${id}`);
        const detalleContent = detalleRow.querySelector('.detalle-content');
        detalleContent.innerHTML = '<p style="color: #e74c3c;">Error al cargar detalles del pedido</p>';
      }
    }

    // --- CAMBIO 3: Función de Toggle Genérica (Maneja Z-INDEX) ---
    // Esta función reemplaza a tu 'toggleEstadoDropdown'
    function toggleDropdown(event, dropdownId) {
      event.stopPropagation();
      const dropdown = document.getElementById(dropdownId);
      const wrapper = dropdown.closest('.dropdown');

      // Cerrar todos los otros dropdowns y resetear su z-index
      document.querySelectorAll('.dropdown-menu').forEach(menu => {
        if (menu.id !== dropdownId) {
          menu.style.display = 'none';
          menu.closest('.dropdown').style.zIndex = 1;
        }
      });

      // Toggle este dropdown
      if (dropdown.style.display === 'none' || !dropdown.style.display) {
        dropdown.style.display = 'block';
        wrapper.style.zIndex = 999; // Sube este dropdown por encima de otros
      } else {
        dropdown.style.display = 'none';
        wrapper.style.zIndex = 1; // Resetea z-index al cerrar
      }
    }

    // --- CAMBIO 4: Función para Estado de ENVÍO ---
    // Renombrada de 'cambiarEstadoDropdown' a 'cambiarEstadoEnvio'
    async function cambiarEstadoEnvio(id, nuevoEstado) {
      document.getElementById(`dropdown-envio-${id}`).style.display = 'none';
      document.getElementById(`dropdown-envio-${id}`).closest('.dropdown').style.zIndex = 1;

      let tracking = null;
      if (nuevoEstado === 'enviado') {
        tracking = prompt('Ingrese número de tracking (opcional):');
      }

      try {
        // Llama a la acción original para el estado general/envío
        const response = await fetch('backend/pedidosController.php?action=actualizar_estado', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            id: id,
            estado: nuevoEstado,
            numero_tracking: tracking,
            nota: `Estado (envío) actualizado por administrador`
          })
        });

        const data = await response.json();

        if (data.success) {
          alert('✅ Estado de envío actualizado correctamente');
          cargarPedidos();
        } else {
          alert('❌ Error: ' + data.error);
        }
      } catch (error) {
        console.error('Error:', error);
        alert('❌ Error al actualizar estado de envío');
      }
    }
    
    // --- CAMBIO 5: NUEVA Función para Estado de PAGO ---
    async function cambiarEstadoPago(id, nuevoEstadoPago) {
      document.getElementById(`dropdown-pago-${id}`).style.display = 'none';
      document.getElementById(`dropdown-pago-${id}`).closest('.dropdown').style.zIndex = 1;

      try {
        // Llama a la NUEVA acción que creamos en el backend
        const response = await fetch('backend/pedidosController.php?action=actualizar_pago', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            id: id,
            estado_pago: nuevoEstadoPago,
            nota: `Estado de pago actualizado por administrador`
          })
        });

        const data = await response.json();

        if (data.success) {
          alert('✅ Estado de pago actualizado correctamente');
          cargarPedidos();
        } else {
          alert('❌ Error: ' + data.error);
        }
      } catch (error) {
        console.error('Error:', error);
        alert('❌ Error al actualizar estado de pago');
      }
    }


    // --- CAMBIO 6: Event listener de clic global (Maneja Z-INDEX) ---
    document.addEventListener('click', function() {
      document.querySelectorAll('.dropdown-menu').forEach(menu => {
        if (menu.style.display !== 'none') {
            menu.style.display = 'none';
            menu.closest('.dropdown').style.zIndex = 1; // Resetea z-index
        }
      });
    });

    // Cerrar modal
    function cerrarModal() {
      document.getElementById('modalDetalles').classList.remove('active');
    }

    // Mostrar error
    function mostrarError(mensaje) {
      const tbody = document.getElementById('tbody');
      tbody.innerHTML = `<tr><td colspan="8" style="text-align:center; padding:40px; color:#e74c3c;">${mensaje}</td></tr>`;
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', () => {
      cargarPedidos();

      // Filtros
      document.querySelectorAll('.chip').forEach(chip => {
        chip.addEventListener('click', () => {
          document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
          chip.classList.add('active');
          filtroActual = chip.dataset.f;
          cargarPedidos();
        });
      });

      // Búsqueda
      document.getElementById('q').addEventListener('input', (e) => {
        busqueda = e.target.value.trim();
        cargarPedidos();
      });

      // Cerrar modal al hacer clic fuera
      document.getElementById('modalDetalles').addEventListener('click', function(e) {
        if (e.target === this) cerrarModal();
      });
    });
  </script>
   
 
  <script src="js/usuarios/user-session.js"></script>
  <script src="js/componente-loader.js"></script>
</body>
</html>